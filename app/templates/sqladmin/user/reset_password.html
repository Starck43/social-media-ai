{% extends "sqladmin/layout.html" %}

{% block title %}Сбросить пароль | Админ панель{% endblock %}

{% block extra_css %}{% endblock %}

{% block main %}
<div class="auth-container">
    <div class="card">
        <div class="card-body">

            <div class="auth-header">
                <h1 class="card-title">Сброс пароля</h1>
                <p>Enter your email to receive reset instructions</p>
            </div>

            {% if request.query_params.get('error') == 'user_not_found' %}
            <div class="alert alert-danger">User not found or has not enough permissions</div>
            {% elif request.query_params.get('error') == 'invalid_csrf' %}
            <div class="alert alert-danger">Security token expired. Please try again.</div>
            {% elif request.query_params.get('error') == 'email_required' %}
            <div class="alert alert-danger">Email is required</div>
            {% elif request.query_params.get('error') == 'server_error' %}
            <div class="alert alert-danger">Server error. Please try again later.</div>
            {% endif %}

            <form id="resetForm" method="post" action="/admin/reset-password">
                <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token }}">

                <div class="form-group">
                    <label for="email">Admin Email</label>
                    <input type="email" id="email" name="email" class="form-control" required
                           placeholder="admin@example.com" value="{{ request.query_params.get('email', '') }}">
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">Reset Password</button>
            </form>

            <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

            <div class="auth-link">
                <a href="/admin/login">← Вернуться назад</a>
            </div>

            {% if debug %}
            <div class="debug-info">
                <strong>Debug Information:</strong><br>
                CSRF Token: {{ csrf_token()|default('Not set')|truncate(20) }}<br>
                Session Keys: {{ request.session.keys()|list }}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("resetForm")
        const submitBtn = document.getElementById("submitBtn")
        const errorDiv = document.getElementById("errorMessage")

        form.addEventListener("submit", async function(e) {
            e.preventDefault()

            const email = document.getElementById("email").value.trim()
            const csrfToken = document.querySelector("input[name=\"csrf_token\"]").value

            // Validate email
            if (!email) {
                showError("Email is required")
                return
            }

            if (!validateEmail(email)) {
                showError("Please enter a valid email address")
                return
            }

            // Show loading state
            submitBtn.disabled = true
            submitBtn.textContent = "Sending..."
            errorDiv.style.display = "none"

            // Проверка CSRF токена
            if (!validateCsrfToken()) {
                showError("Security token missing. Please refresh the page.", true)
                return
            }

            const formData = new URLSearchParams()
            formData.append("email", email)
            formData.append("csrf_token", csrfToken)

            try {
                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRF-Token": csrfToken,
                    },
                    credentials: "same-origin",
                })

                if (response.status === 303) {
                    const redirectUrl = response.headers.get("Location")
                    if (redirectUrl) {
                        window.location.href = redirectUrl
                        return
                    }
                }

                try {
                    const result = await response.json()

                    if (response.ok) {
                        window.location.href = "/admin/login?message=password_reset"
                    } else {
                        showError(result.error || result.detail || "An error occurred. Please try again.")

                        if (response.status === 403) {
                            showError("Session expired. Reloading page...", true)
                        }
                    }
                } catch (jsonError) {
                    if (response.ok) {
                        window.location.href = "/admin/login?message=password_reset"
                    } else {
                        showError("Password reset failed. Please try again.")
                    }
                }

            } catch (error) {
                console.error("Network error:", error)
                showError("Network error. Please check your connection.")
            } finally {
                submitBtn.disabled = false
                submitBtn.textContent = "Reset Password"
            }
        })

        // Обработка query параметров для предзаполнения email
        const urlParams = new URLSearchParams(window.location.search)
        const emailParam = urlParams.get("email")
        if (emailParam) {
            document.getElementById("email").value = emailParam
        }
    })
</script>
{% endblock %}
