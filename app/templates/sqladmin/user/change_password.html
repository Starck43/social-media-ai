{% extends "sqladmin/layout.html" %}

{% block title %}–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è - –ê–¥–∏–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="card">
        <div class="card-body">

            <div class="auth-header">
                <h1>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h1>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</p>
            </div>

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
            {% endfor %}
            {% endif %}

            <form method="post" id="changePasswordForm">
                <input type="hidden" name="csrf_token"
                       value="{{ csrf_token or request.session.get('csrf_token', '') }}">

                <div class="form-group" id="current-password-group">
                    <label for="current_password">Current Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="current_password" name="current_password" class="form-control"
                               required>
                        <button type="button" class="toggle-password" data-target="current_password">üëÅÔ∏è</button>
                    </div>
                    <div class="error-messages" id="current-password-error" style="display: none;"></div>
                </div>

                <div class="form-group" id="new-password-group">
                    <label for="new_password">New Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="new_password" name="new_password" class="form-control" required
                               minlength="{{ password_settings.PASSWORD_MIN_LENGTH }}"
                               data-min-length="{{ password_settings.PASSWORD_MIN_LENGTH }}"
                               data-require-upper="{{ 'true' if password_settings.PASSWORD_REQUIRE_UPPERCASE else 'false' }}"
                               data-require-lower="{{ 'true' if password_settings.PASSWORD_REQUIRE_LOWERCASE else 'false' }}"
                               data-require-number="{{ 'true' if password_settings.PASSWORD_REQUIRE_NUMBERS else 'false' }}"
                               data-require-special="{{ 'true' if password_settings.PASSWORD_REQUIRE_SPECIAL else 'false' }}">
                        <button type="button" class="toggle-password" data-target="new_password">üëÅÔ∏è‚Äçüó®Ô∏è</button>
                    </div>
                    <div class="error-messages" id="new-password-error" style="display: none;"></div>
                </div>

                <div class="form-group" id="confirm-password-group">
                    <label for="confirm_password">Confirm Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="confirm_password" name="confirm_password" class="form-control"
                               required
                               minlength="{{ password_settings.PASSWORD_MIN_LENGTH }}">
                        <button type="button" class="toggle-password" data-target="confirm_password">üëÅÔ∏è‚Äçüó®Ô∏è</button>
                    </div>
                    <div class="error-messages" id="confirm-password-error" style="display: none;"></div>

                    <small class="password-hint">
                        Password must be at least {{ password_settings.PASSWORD_MIN_LENGTH }} characters{% if
                        password_settings.PASSWORD_REQUIRE_UPPERCASE %}, include uppercase letters{% endif %}{% if
                        password_settings.PASSWORD_REQUIRE_LOWERCASE %}, include lowercase letters{% endif %}{% if
                        password_settings.PASSWORD_REQUIRE_NUMBERS %}, include numbers{% endif %}{% if
                        password_settings.PASSWORD_REQUIRE_SPECIAL %}, include special characters{% endif %}
                    </small>
                    <div class="password-strength-meter">
                        <div class="strength-bar"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="{{ return_url or '/admin/user/list' }}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("changePasswordForm")
        const currentPassword = document.getElementById("current_password")
        const currentPasswordError = document.getElementById("current-password-error")
        const currentPasswordGroup = document.getElementById("current-password-group")
        const newPassword = document.getElementById("new_password")
        const newPasswordError = document.getElementById("new-password-error")
        const newPasswordGroup = document.getElementById("new-password-group")
        const confirmPassword = document.getElementById("confirm_password")
        const confirmPasswordError = document.getElementById("confirm-password-error")
        const confirmPasswordGroup = document.getElementById("confirm-password-group")
        const strengthBar = document.querySelector(".strength-bar")

        function showPasswordError(element, group, message) {
            element.textContent = message
            element.style.display = "block"
            group.classList.add("has-error")
        }

        function clearPasswordError(element, group) {
            element.textContent = ""
            element.style.display = "none"
            group.classList.remove("has-error")
        }

        async function verifyCurrentPassword(password) {
            try {
                const response = await fetch("/admin/verify-current-password", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-Token": document.querySelector("input[name=\"csrf_token\"]").value,
                    },
                    body: JSON.stringify({ current_password: password }),
                })

                const result = await response.json()
                return result.valid
            } catch (error) {
                console.error("Password verification error:", error)
                return false
            }
        }

        function validatePasswordComplexity(password) {
            const minLength = parseInt(newPassword.dataset.minLength) || 8
            const requireUpper = newPassword.dataset.requireUpper === "true"
            const requireLower = newPassword.dataset.requireLower === "true"
            const requireNumber = newPassword.dataset.requireNumber === "true"
            const requireSpecial = newPassword.dataset.requireSpecial === "true"

            if (password.length < minLength) {
                return `Password must be at least ${minLength} characters long`
            }

            if (requireUpper && !/[A-Z]/.test(password)) {
                return "Password must contain at least one uppercase letter"
            }

            if (requireLower && !/[a-z]/.test(password)) {
                return "Password must contain at least one lowercase letter"
            }

            if (requireNumber && !/\d/.test(password)) {
                return "Password must contain at least one number"
            }

            if (requireSpecial && !/[!@#$%^&*]/.test(password)) {
                return "Password must contain at least one special character (!@#$%^&*)"
            }

            return null
        }

        // Check current password on enter
        currentPassword.addEventListener("blur", async function() {
            if (this.value.length > 0) {
                const isValid = await verifyCurrentPassword(this.value)
                if (!isValid) {
                    showPasswordError(currentPasswordError, currentPasswordGroup, "Current password is incorrect")
                    this.setCustomValidity("Current password is incorrect")
                } else {
                    clearPasswordError(currentPasswordError, currentPasswordGroup)
                    this.setCustomValidity("")
                }
            }
        })

        function checkPasswordMatch() {
            if (newPassword.value && confirmPassword.value) {
                if (newPassword.value !== confirmPassword.value) {
                    showPasswordError(confirmPasswordError, confirmPasswordGroup, "Passwords do not match")
                    confirmPassword.setCustomValidity("Passwords do not match")
                    return false
                } else {
                    clearPasswordError(confirmPasswordError, confirmPasswordGroup)
                    confirmPassword.setCustomValidity("")
                    return true
                }
            }
            return true
        }

        function checkNewPasswordDifferent() {
            if (currentPassword.value && newPassword.value && currentPassword.value === newPassword.value) {
                showPasswordError(newPasswordError, newPasswordGroup, "New password must be different from current password")
                newPassword.setCustomValidity("New password must be different from current password")
                return false
            } else {
                clearPasswordError(newPasswordError, newPasswordGroup)
                newPassword.setCustomValidity("")
                return true
            }
        }

        function updatePasswordStrength(password) {
            let strength = 0
            const minLength = parseInt(newPassword.dataset.minLength) || 8

            // Length check
            if (password.length >= minLength) strength += 25
            if (password.length >= minLength + 4) strength += 10

            // Complexity checks
            if (/[A-Z]/.test(password) && newPassword.dataset.requireUpper === "true") strength += 15
            if (/[a-z]/.test(password) && newPassword.dataset.requireLower === "true") strength += 15
            if (/\d/.test(password) && newPassword.dataset.requireNumber === "true") strength += 15
            if (/[^A-Za-z0-9]/.test(password) && newPassword.dataset.requireSpecial === "true") strength += 20

            // Update strength bar
            strengthBar.style.width = Math.min(100, strength) + "%"

            // Update color based on strength
            if (strength < 50) {
                strengthBar.style.backgroundColor = "#ef4444" // red
            } else if (strength < 75) {
                strengthBar.style.backgroundColor = "#f59e0b" // yellow
            } else {
                strengthBar.style.backgroundColor = "#10b981" // green
            }
        }

        // Event listeners
        newPassword.addEventListener("input", function() {
            const complexityError = validatePasswordComplexity(this.value)
            if (complexityError) {
                showPasswordError(newPasswordError, newPasswordGroup, complexityError)
            } else {
                clearPasswordError(newPasswordError, newPasswordGroup)
            }

            updatePasswordStrength(this.value)
            checkPasswordMatch()
            checkNewPasswordDifferent()
        })

        confirmPassword.addEventListener("input", checkPasswordMatch)
        currentPassword.addEventListener("input", checkNewPasswordDifferent)

        form.addEventListener("submit", async function(e) {
            if (!validateCsrfToken()) {
                e.preventDefault()
                showPasswordError("Security token missing. Please refresh the page.", true)
                return false
            }

            // Validate current password
            if (currentPassword.value) {
                const isValid = await verifyCurrentPassword(currentPassword.value)
                if (!isValid) {
                    e.preventDefault()
                    showPasswordError(currentPasswordError, currentPasswordGroup, "Current password is incorrect")
                    currentPassword.focus()
                    return false
                }
            }

            // Validate password complexity
            const complexityError = validatePasswordComplexity(newPassword.value)
            if (complexityError) {
                e.preventDefault()
                showPasswordError(newPasswordError, newPasswordGroup, complexityError)
                newPassword.focus()
                return false
            }

            // Check if passwords match
            if (!checkPasswordMatch()) {
                e.preventDefault()
                confirmPassword.focus()
                return false
            }

            // Check if new password is different
            if (!checkNewPasswordDifferent()) {
                e.preventDefault()
                newPassword.focus()
                return false
            }

            return true
        })
    })
</script>
{% endblock %}
