# Notifications, Dashboard & Messenger Integration

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ dashboard –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞–º–∏ (Telegram, VK) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω—É.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Services/API   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  Notifications   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  Messenger      ‚îÇ
‚îÇ                 ‚îÇ      ‚îÇ  (Database)      ‚îÇ      ‚îÇ  (Telegram/VK)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                        ‚îÇ                         ‚îÇ
         ‚îÇ                        ‚îÇ                         ‚îÇ
         v                        v                         v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Admin Panel    ‚îÇ      ‚îÇ   Dashboard API  ‚îÇ      ‚îÇ  Admin Chat     ‚îÇ
‚îÇ  (Views)        ‚îÇ      ‚îÇ   (Filters)      ‚îÇ      ‚îÇ  (Critical)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Notification Model & Manager

**–ú–æ–¥–µ–ª—å:** `app/models/notification.py`

```python
class Notification:
    id: int
    title: str
    message: str
    notification_type: NotificationType  # Enum —Ç–∏–ø
    is_read: bool
    related_entity_type: str  # 'source', 'platform', 'analysis'
    related_entity_id: int
    created_at: datetime
    updated_at: datetime
```

**–ú–µ–Ω–µ–¥–∂–µ—Ä:** `app/models/managers/notification_manager.py`

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã:
- `create_notification()` - —Å–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `get_unread()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
- `mark_as_read()` - –ø–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
- `get_by_type()` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
- `get_recent()` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 2. Notification Service

**–°–µ—Ä–≤–∏—Å:** `app/services/notifications/service.py`

–í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏:

```python
from app.services.notifications.service import notify

# –°–æ–∑–¥–∞–Ω–∏–µ —Å –∞–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä
notification = await notify.create(
    title="Critical Error",
    message="API connection failed",
    ntype=NotificationType.API_ERROR,
    entity_type="platform",
    entity_id=platform_id,
    send_to_messenger=True  # –û—Ç–ø—Ä–∞–≤–∏—Ç –≤ Telegram
)

# –ì–æ—Ç–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤
await notify.report_ready("Analytics", "Dashboard")
await notify.api_error("VK API failed", "Connection timeout")
await notify.rate_limit_warning("VK", remaining=10)
await notify.keyword_mention(source_id, "important", "Context text")
```

### 3. Messenger Service

**–°–µ—Ä–≤–∏—Å:** `app/services/notifications/messenger.py`

–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã:

```python
from app.services.notifications.messenger import messenger_service

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
result = await messenger_service.send_notification(
    title="Alert",
    message="Something happened",
    notification_type=NotificationType.API_ERROR,
    messenger="telegram",  # –∏–ª–∏ "vk" –∏–ª–∏ "all"
    recipient_id="chat_id"  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
)

# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–≤–æ –≤—Å–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã)
await messenger_service.send_critical_alert(
    title="System Error",
    message="Database connection lost",
    error_details="Connection timeout after 30s"
)

# –ì–æ—Ç–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
await messenger_service.send_report_ready("Weekly Report", "/reports/weekly")
await messenger_service.send_trend_alert("VK Group", "Negative trend detected", "negative")
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ `.env`:**
```bash
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_ADMIN_CHAT_ID=your_chat_id_here
VK_APP_SECRET=your_vk_secret
```

### 4. API Endpoints - Notifications

**–†–æ—É—Ç–µ—Ä:** `app/api/v1/endpoints/notifications.py`

#### –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
```http
GET /api/v1/notifications/notifications
    ?is_read=false
    &notification_type=API_ERROR
    &since=2024-01-01T00:00:00
    &limit=50
    &offset=0
```

Response:
```json
[
    {
        "id": 1,
        "title": "Error collecting data",
        "message": "Failed to collect...",
        "notification_type": "API_ERROR",
        "is_read": false,
        "related_entity_type": "source",
        "related_entity_id": 5,
        "created_at": "2024-10-11T12:00:00"
    }
]
```

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```http
GET /api/v1/notifications/notifications/stats?since=2024-01-01
```

Response:
```json
{
    "total": 150,
    "unread": 25,
    "by_type": {
        "API_ERROR": 10,
        "REPORT_READY": 40,
        "TREND_ALERT": 5
    }
}
```

#### –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```http
POST /api/v1/notifications/notifications
Authorization: Bearer {token}

{
    "title": "Custom Alert",
    "message": "Something important",
    "notification_type": "SYSTEM_UPDATE",
    "related_entity_type": "platform",
    "related_entity_id": 1
}
```

#### –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
```http
POST /api/v1/notifications/notifications/{id}/mark-read
```

#### –ü–æ–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
```http
POST /api/v1/notifications/notifications/mark-all-read
```

#### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```http
POST /api/v1/notifications/notifications/cleanup?days=30
Authorization: Bearer {admin_token}
```

### 5. API Endpoints - Dashboard

**–†–æ—É—Ç–µ—Ä:** `app/api/v1/endpoints/dashboard.py`

#### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```http
GET /api/v1/dashboard/dashboard/stats
    ?platform_id=1
    &source_type=GROUP
    &since=2024-01-01
```

Response:
```json
{
    "total_sources": 50,
    "active_sources": 45,
    "total_platforms": 2,
    "active_platforms": 2,
    "total_analytics": 1250,
    "unread_notifications": 15,
    "sources_by_platform": {
        "VK": 30,
        "Telegram": 20
    },
    "sources_by_type": {
        "GROUP": 25,
        "CHANNEL": 15,
        "USER": 10
    },
    "analytics_by_period": {
        "daily": 1000,
        "weekly": 200,
        "monthly": 50
    }
}
```

#### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏
```http
GET /api/v1/dashboard/dashboard/sources
    ?platform_id=1
    &source_type=GROUP
    &is_active=true
    &has_scenario=true
    &limit=50
```

Response:
```json
[
    {
        "id": 1,
        "name": "Tech News",
        "platform_name": "VK",
        "source_type": "GROUP",
        "is_active": true,
        "last_checked": "2024-10-11T12:00:00",
        "analytics_count": 45,
        "bot_scenario_name": "Sentiment Analysis"
    }
]
```

#### –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
```http
GET /api/v1/dashboard/dashboard/analytics
    ?source_id=1
    &period_type=DAILY
    &since=2024-01-01
    &limit=50
```

#### –¢—Ä–µ–Ω–¥—ã –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞
```http
GET /api/v1/dashboard/dashboard/trends/1
    ?days=30
    &metric=sentiment  # –∏–ª–∏ activity, engagement
```

Response:
```json
[
    {
        "date": "2024-10-11",
        "value": 0.75,
        "label": "positive"
    },
    {
        "date": "2024-10-12",
        "value": 0.65,
        "label": "positive"
    }
]
```

#### –ü–æ—Å–ª–µ–¥–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
```http
GET /api/v1/dashboard/dashboard/notifications/recent?limit=10
```

### 6. Admin Panel Integration

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ Views:** `app/admin/views.py`

#### NotificationAdmin

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ / üì¨ –ù–æ–≤–æ–µ
- Action: "–ü–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º" - –º–∞—Å—Å–æ–≤–æ –ø–æ–º–µ—á–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
- Action: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä" - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
1. –í—ã–±—Ä–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
2. –ù–∞–∂–∞—Ç—å "–ü–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º" –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø–æ–º–µ—Ç–∫–∏
3. –ù–∞–∂–∞—Ç—å "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä" –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö

#### BotScenarioAdmin

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ö–∞—Å—Ç–æ–º–Ω—ã–π —à–∞–±–ª–æ–Ω —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º scope
- –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã (Sentiment, Trends, Engagement, Keywords)
- JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤
- Action: "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å/–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å" - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
2. –í—ã–±—Ä–∞—Ç—å –ø—Ä–µ—Å–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π scope
3. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å JSON –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
4. –ü—Ä–æ–º–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ {variable_name}

### 7. –®–∞–±–ª–æ–Ω—ã

#### Bot Scenario Create Template
**–§–∞–π–ª:** `app/templates/sqladmin/bot_scenario_create.html`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä scope
- 4 –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–µ—Å–µ—Ç–∞:
  - Sentiment Analysis
  - Trend Detection
  - Engagement Analysis
  - Keyword Monitoring
- JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- –ö–Ω–æ–ø–∫–∏ "Add Variable", "Format JSON"
- –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤

### 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å–µ—Ä–≤–∏—Å—ã

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**ContentCollector** (`app/services/monitoring/collector.py`):

```python
# –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# 1. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞
# 2. –°–æ–∑–¥–∞—ë—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
# 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Telegram –∞–¥–º–∏–Ω—É

except Exception as e:
    logger.error(f"Error collecting: {e}")
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await notify.create(
        title=f"Error collecting from {source.name}",
        message=f"Failed: {str(e)}",
        ntype=NotificationType.API_ERROR,
        entity_type="source",
        entity_id=source.id,
        send_to_messenger=True  # –í Telegram
    )
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

```python
from app.services.monitoring.collector import ContentCollector
from app.services.notifications.service import notify

collector = ContentCollector()

# –°–±–æ—Ä —Å –∞–≤—Ç–æ—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
result = await collector.collect_from_source(source, analyze=True)

if result:
    # –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
    await notify.report_ready(
        entity_type="source",
        entity_id=source.id,
        title=f"Data collected from {source.name}",
        message=f"Collected {result['content_count']} items"
    )
```

### 2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã

```python
from app.services.notifications.messenger import messenger_service

# –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É
try:
    # –ö–∞–∫–∞—è-—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
    result = await critical_operation()
except Exception as e:
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç
    await messenger_service.send_critical_alert(
        title="Critical System Error",
        message="Failed to connect to database",
        error_details=str(e)
    )
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å dashboard

```python
from app.api.v1.endpoints.dashboard import get_dashboard_stats

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è dashboard
stats = await get_dashboard_stats(
    platform_id=1,
    source_type=SourceType.GROUP,
    since=date.today() - timedelta(days=30)
)

# stats —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
print(f"Active sources: {stats.active_sources}")
print(f"Unread notifications: {stats.unread_notifications}")
```

### 4. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```python
# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
notifications = await Notification.objects.filter(
    is_read=False,
    notification_type=NotificationType.API_ERROR,
    created_at__gte=datetime.now() - timedelta(days=7)
)

for n in notifications:
    print(f"{n.title}: {n.message}")
    await Notification.objects.update_by_id(n.id, is_read=True)
```

## –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```python
class NotificationType(Enum):
    REPORT_READY = "report_ready"
    MOOD_CHANGE = "mood_change"
    TREND_ALERT = "trend_alert"
    TOPIC_RESUMED = "topic_resumed"
    API_ERROR = "api_error"
    CONNECTION_ERROR = "connection_error"
    SOURCE_INACTIVE = "source_inactive"
    RATE_LIMIT_WARNING = "rate_limit_warning"
    BOT_COMMENT = "bot_comment"
    BOT_SKIPPED = "bot_skipped"
    SYSTEM_BACKUP = "system_backup"
    SYSTEM_UPDATE = "system_update"
    SUBSCRIBED_ACTIVITY = "subscribed_activity"
    KEYWORD_MENTION = "keyword_mention"
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∏–ø—ã** (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
- API_ERROR
- CONNECTION_ERROR
- SYSTEM_BACKUP

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```python
import logging
logger = logging.getLogger(__name__)

# –í —Å–µ—Ä–≤–∏—Å–∞—Ö
logger.info(f"Creating notification: {title}")
logger.error(f"Failed to send to messenger: {e}", exc_info=True)

# –í API
logger.info(f"User {user.username} listing notifications")
logger.warning(f"Notification {id} not found")

# –í admin
logger.info(f"Scenario {pk} status changed to {status}")
logger.error(f"Error toggling scenario {pk}: {e}")
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Bot

### 1. –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞
1. –û—Ç–∫—Ä—ã—Ç—å [@BotFather](https://t.me/botfather) –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/newbot`
3. –°–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
4. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`

### 2. –ü–æ–ª—É—á–∏—Ç—å Chat ID
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
2. –û—Ç–∫—Ä—ã—Ç—å: `https://api.telegram.org/bot<TOKEN>/getUpdates`
3. –ù–∞–π—Ç–∏ `"chat":{"id":123456789}`

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ `.env`
```bash
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_ADMIN_CHAT_ID=123456789
```

## Testing

```python
# –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
from app.services.notifications.messenger import messenger_service

result = await messenger_service._send_telegram(
    title="Test",
    message="Hello from bot!",
    is_critical=False
)

print(result)  # {'success': True, 'chat_id': '...'}
```

## Troubleshooting

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Telegram
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TELEGRAM_BOT_TOKEN` –∏ `TELEGRAM_ADMIN_CHAT_ID` –≤ `.env`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –±–æ—Ç—É —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `logger.error(...)`

### Dashboard –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: `await Source.objects.filter()`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: `await AIAnalytics.objects.filter()`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –∑–∞–ø—Ä–æ—Å–µ

### Scope –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ scope - –≤–∞–ª–∏–¥–Ω—ã–π JSON
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –ø—Ä–æ–º–ø—Ç–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –∫–ª—é—á–∞–º–∏ scope
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `{variable_name}` –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏

## Best Practices

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –≤—ã–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π NotificationType
2. **–õ–æ–≥–∏—Ä—É–π—Ç–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ logger.error –¥–ª—è –æ—à–∏–±–æ–∫
3. **–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ** - `send_to_messenger=True` –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
4. **–û—á–∏—â–∞–π—Ç–µ —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ cleanup endpoint —Ä–µ–≥—É–ª—è—Ä–Ω–æ
5. **–§–∏–ª—å—Ç—Ä—É–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ API —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
6. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ dashboard** - —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ç—Ä–µ–Ω–¥—ã
7. **–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏** - –æ–¥–∏–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## Security

1. **Admin endpoints** —Ç—Ä–µ–±—É—é—Ç `is_superuser=True`
2. **–¢–æ–∫–µ–Ω—ã –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–≤** —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `.env`, –Ω–µ –≤ –∫–æ–¥–µ
3. **–õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç** —Ç–æ–∫–µ–Ω—ã –∏ —Å–µ–∫—Ä–µ—Ç—ã
4. **Rate limiting** –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ API endpoints
5. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** —á–µ—Ä–µ–∑ Pydantic models
