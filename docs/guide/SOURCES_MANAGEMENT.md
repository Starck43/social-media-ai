# Работа с источниками контента

## Обзор

Источники контента (Source) - это конкретные аккаунты, каналы или страницы в социальных сетях, которые система мониторит и анализирует. Каждый источник связан с определенной платформой (VK, Telegram, etc.) и может использовать один сценарий анализа (BotScenario).

## Создание источника

### Шаг 1: Выбор платформы

Перед созданием источника необходимо определить платформу:
- **VK (ВКонтакте)** - группы, публичные страницы, личные аккаунты
- **Telegram** - каналы, чаты, боты
- **YouTube** - каналы, видео
- **Twitter/X** - аккаунты, твиты
- **Instagram** - аккаунты, посты

### Шаг 2: Настройка подключения

Для каждой платформы требуются разные параметры:

#### VK
```json
{
  "platform": "vk",
  "source_type": "group",
  "credentials": {
    "access_token": "ваш_токен_доступа",
    "group_id": "id_группы_или_страницы"
  }
}
```

#### Telegram
```json
{
  "platform": "telegram",
  "source_type": "channel",
  "credentials": {
    "bot_token": "токен_бота",
    "channel_username": "username_канала"
  }
}
```

### Шаг 3: Связывание со сценарием

Каждый источник должен быть связан с BotScenario, который определяет:
- Какие типы контента анализировать
- Какой AI использовать для анализа
- Какие триггеры и действия применять

## Управление источниками

### Активация/деактивация

Источники можно включать и отключать без удаления:
- Активные источники участвуют в сборе и анализе контента
- Неактивные источники сохраняются в системе для возможного повторного использования

### Мониторинг статуса

Система отслеживает статус каждого источника:
- **Активен** - сбор контента работает нормально
- **Ошибка авторизации** - проблемы с API ключами
- **Превышен лимит** - исчерпан лимит запросов к API
- **Неактивен** - отключен администратором

## Лучшие практики

### 1. Распределение нагрузки

Распределяйте источники между разными сценариями для балансировки нагрузки:
```python
# Рекомендация: не более 10 активных источников на один сценарий
scenario_1 = BotScenario.objects.get(name="Основной анализ")
scenario_2 = BotScenario.objects.get(name="Быстрый анализ")

# Распределение источников
for i, source in enumerate(sources):
    scenario = scenario_1 if i % 2 == 0 else scenario_2
    source.bot_scenario = scenario
    source.save()
```

### 2. Мониторинг производительности

Регулярно проверяйте эффективность источников:
- Количество успешно обработанного контента
- Среднее время анализа
- Частота ошибок API

### 3. Обработка ошибок

Настройте уведомления для критических ошибок:
```python
# Пример настройки уведомлений в trigger_config
{
  "error_threshold": 5,
  "notification_email": "admin@example.com",
  "auto_deactivate": true
}
```

## Расширенная конфигурация

### Фильтры контента

Настройте фильтры для исключения нежелательного контента:

#### По ключевым словам
```json
{
  "keyword_filter": {
    "include": ["важная", "тема", "анализ"],
    "exclude": ["спам", "реклама"],
    "mode": "all"  // all, any, none
  }
}
```

#### По типу контента
```json
{
  "content_filter": {
    "allowed_types": ["posts", "comments", "photos"],
    "min_length": 10,
    "max_length": 2000
  }
}
```

## Интеграция с внешними системами

Источники могут интегрироваться с внешними сервисами для расширенного функционала:

### Вебхуки
```json
{
  "webhooks": {
    "on_new_content": "https://your-api.com/webhook/new",
    "on_analysis_complete": "https://your-api.com/webhook/analysis",
    "on_error": "https://your-api.com/webhook/error"
  }
}
```

### Кастомные парсеры
Для платформ без официального API можно использовать кастомные парсеры:
```json
{
  "custom_parser": {
    "enabled": true,
    "parser_type": "selenium",
    "schedule": "0 */6 * * *",  // каждые 6 часов
    "selectors": {
      "posts": ".post-content",
      "comments": ".comment-text"
    }
  }
}
```

## Диагностика и отладка

### Логи источников

Проверяйте логи для диагностики проблем:
```python
# Просмотр последних логов источника
logs = SourceLog.objects.filter(source=source).order_by('-created_at')[:50]

for log in logs:
    print(f"{log.level}: {log.message}")
```

### Тестирование подключения

Используйте встроенные инструменты тестирования:
```python
# Тест подключения к источнику
from app.services.social.source_tester import SourceTester

tester = SourceTester(source)
result = await tester.test_connection()

if result.success:
    print(f"Подключение успешно: {result.details}")
else:
    print(f"Ошибка: {result.error}")
```

## Производительность и оптимизация

### Кеширование

Настройте кеширование для часто используемых данных:
```json
{
  "caching": {
    "enabled": true,
    "ttl_seconds": 3600,
    "cache_types": ["posts", "comments", "profiles"]
  }
}
```

### Пакетная обработка

Используйте пакетную обработку для повышения производительности:
```json
{
  "batch_processing": {
    "enabled": true,
    "batch_size": 50,
    "delay_between_batches": 2
  }
}
```

## Безопасность

### Управление доступом

Настройте granular permissions для источников:
```python
# Пример настройки прав доступа
source.permissions = {
    "view": ["analyst", "manager"],
    "edit": ["manager"],
    "delete": ["admin"]
}
```

### Шифрование учетных данных

Все чувствительные данные автоматически шифруются:
- API ключи
- Токены доступа
- Пароли

## Мониторинг и алертинг

### Метрики производительности

Отслеживайте ключевые метрики:
- Время ответа API платформ
- Количество обработанного контента в час
- Процент успешных запросов
- Средняя нагрузка на CPU/память

### Настройка алертов

Создайте кастомные алерты для мониторинга:
```json
{
  "alerts": {
    "error_rate_threshold": 0.05,
    "response_time_threshold": 30,
    "notification_channels": ["email", "slack"]
  }
}
```

## Заключение

Эффективное управление источниками контента требует:
1. Правильной настройки подключений
2. Регулярного мониторинга производительности
3. Грамотного распределения нагрузки
4. Своевременного реагирования на ошибки

Следуя этим рекомендациям, вы обеспечите стабильную и эффективную работу системы мониторинга социальных сетей.
