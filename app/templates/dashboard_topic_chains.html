<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
		.topic-chain-card {
			transition: transform 0.2s;
			cursor: pointer;
		}

		.topic-chain-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		.sentiment-positive {
			color: #28a745;
		}

		.sentiment-negative {
			color: #dc3545;
		}

		.sentiment-neutral {
			color: #6c757d;
		}

		.topic-tag {
			display: inline-block;
			background: #e9ecef;
			padding: 2px 8px;
			margin: 2px;
			border-radius: 12px;
			font-size: 0.85em;
		}

		.chart-container {
			position: relative;
			height: 300px;
			margin: 20px 0;
		}
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-project-diagram me-2"></i>Дашборд</h1>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>Обновить
                    </button>
                    <button class="btn btn-primary" onclick="exportData()">
                        <i class="fas fa-download me-1"></i>Экспорт
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card topic-chain-card">
                <div class="card-body text-center">
                    <h5 class="card-title">Активных цепочек</h5>
                    <h2 class="text-primary" id="activeChainsCount">-</h2>
                    <small class="text-muted">постоянно обновляются</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card topic-chain-card">
                <div class="card-body text-center">
                    <h5 class="card-title">Всего тем</h5>
                    <h2 class="text-info" id="totalTopicsCount">-</h2>
                    <small class="text-muted">уникальных тем</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card topic-chain-card">
                <div class="card-body text-center">
                    <h5 class="card-title">Источников</h5>
                    <h2 class="text-success" id="sourcesCount">-</h2>
                    <small class="text-muted">с анализом</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card topic-chain-card">
                <div class="card-body text-center">
                    <h5 class="card-title">Анализов</h5>
                    <h2 class="text-warning" id="totalAnalysesCount">-</h2>
                    <small class="text-muted">обработано</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Chains Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list me-2"></i>Цепочки тем</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="topicChainsTable" class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>ID цепочки</th>
                                <th>Источник</th>
                                <th>Анализов</th>
                                <th>Период</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody id="topicChainsTableBody">
                            <!-- Данные будут загружены через JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Evolution Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line me-2"></i>Эволюция тем</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topicEvolutionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Details Modal -->
    <div class="modal fade" id="topicDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Детали цепочки тем</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="topicDetailsContent">
                    <!-- Детали будут загружены через JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Custom JS -->
<script>
    let topicEvolutionChart = null
    let topicChainsTable = null
    let modalChart = null

    // Load data on page load
    document.addEventListener("DOMContentLoaded", function() {
        loadTopicChains()
        loadOverviewStats()

        // Load default chart data (first chain)
        setTimeout(() => {
            loadDefaultEvolutionChart()
        }, 1000)
    })

    // Load data for default chart
    async function loadDefaultEvolutionChart() {
        try {
            const response = await fetch("/api/v1/dashboard/topic-chains")
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`)
            }
            const chains = await response.json()

            if (chains.length > 0) {
                const firstChainId = chains[0].chain_id

                const evolutionResponse = await fetch(`/api/v1/dashboard/topic-chains/${firstChainId}/evolution`)
                if (evolutionResponse.ok) {
                    const evolutionData = await evolutionResponse.json()

                    if (evolutionData && evolutionData.length > 0) {
                        buildEvolutionChart(evolutionData)
                    }
                }
            }
        } catch (error) {
            console.error("Error loading default chart data:", error)
        }
    }

    // Load topic chains list
    async function loadTopicChains() {
        try {
            const response = await fetch("/api/v1/dashboard/topic-chains")
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`)
            }
            const chains = await response.json()

            updateTopicChainsTable(chains)
        } catch (error) {
            console.error("Error loading topic chains:", error)
            document.getElementById("topicChainsTableBody").innerHTML =
                `<tr><td colspan="6" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`
        }
    }

    // Update topic chains table
    function updateTopicChainsTable(chains) {
        const tbody = document.getElementById("topicChainsTableBody")

        if (topicChainsTable) {
            topicChainsTable.destroy()
        }

        tbody.innerHTML = ""

        chains.forEach(chain => {
            const row = document.createElement("tr")
            row.innerHTML = `
                    <td><code>${chain.chain_id}</code></td>
                    <td>${chain.source_id}</td>
                    <td>${chain.analyses_count}</td>
                    <td>${formatDate(chain.first_date)} - ${formatDate(chain.last_date)}</td>
                    <td><span class="badge bg-success">Active</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewTopicChain('${chain.chain_id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                    </td>
                `
            tbody.appendChild(row)
        })

        // Initialize DataTables
        if (typeof DataTable !== "undefined") {
            topicChainsTable = new DataTable("#topicChainsTable", {
                pageLength: 25,
                responsive: true,
            })
        } else {
            console.warn("DataTables not loaded")
        }
    }

    // Load overview statistics
    async function loadOverviewStats() {
        try {
            const response = await fetch("/api/v1/dashboard/stats")
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`)
            }
            const stats = await response.json()

            document.getElementById("activeChainsCount").textContent = stats.total_sources || 0
            document.getElementById("totalTopicsCount").textContent = stats.total_topics || 0
            document.getElementById("sourcesCount").textContent = stats.total_sources || 0
            document.getElementById("totalAnalysesCount").textContent = stats.total_analytics || 0
        } catch (error) {
            console.error("Error loading statistics:", error)
        }
    }

    // View topic chain
    async function viewTopicChain(chainId) {
        try {
            // Load chain details
            const response = await fetch(`/api/v1/dashboard/topic-chains/${chainId}`)
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`)
            }

            const chainDetails = await response.json()

            // Load evolution data
            const evolutionResponse = await fetch(`/api/v1/dashboard/topic-chains/${chainId}/evolution`)
            if (!evolutionResponse.ok) {
                throw new Error(`HTTP ${evolutionResponse.status}: ${evolutionResponse.statusText}`)
            }

            const evolutionData = await evolutionResponse.json()
            showTopicDetails(chainDetails, evolutionData)
        } catch (error) {
            console.error("Error loading chain details:", error)
            alert(`Error loading chain data: ${error.message}`)
        }
    }

    // Display topic chain details
    function showTopicDetails(chainDetails, evolutionData) {
        const modal = new bootstrap.Modal(document.getElementById("topicDetailsModal"))
        const content = document.getElementById("topicDetailsContent")

        // Build modal content
        content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Chain Information</h6>
                        <p><strong>ID:</strong> ${chainDetails.chain_id}</p>
                        <p><strong>Source:</strong> ${chainDetails.source_info.name}</p>
                        <p><strong>Total Analyses:</strong> ${chainDetails.total_analyses}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Topic Statistics</h6>
                        <p><strong>Unique Topics:</strong> ${chainDetails.topic_statistics.total_topics}</p>
                        <p><strong>Most Frequent Topic:</strong> ${chainDetails.topic_statistics.most_frequent_topics[0]?.[0] || "No data"}</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Topic Evolution</h6>
                        <div class="chart-container">
                            <canvas id="modalChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Analysis Timeline</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Topics</th>
                                        <th>Metrics</th>
                                    </tr>
                                </thead>
                                <tbody id="timelineBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `

        // Update timeline
        const timelineBody = document.getElementById("timelineBody")
        chainDetails.chain_data.evolution.forEach(analysis => {
            const row = document.createElement("tr")
            const topics = analysis.topics.slice(0, 3).map(t => `<span class="topic-tag">${t.topic}</span>`).join("")
            row.innerHTML = `
                    <td>${formatDate(analysis.date)}</td>
                    <td>${topics}</td>
                    <td>
                        Posts: ${analysis.metrics.total_posts}<br>
                        Sentiment: ${analysis.metrics.sentiment_score.toFixed(2)}
                    </td>
                `
            timelineBody.appendChild(row)
        })

        // Build evolution charts
        if (evolutionData && evolutionData.length > 0) {
            buildEvolutionChart(evolutionData)
            buildModalEvolutionChart(evolutionData)
        }

        modal.show()
    }

    // Build evolution chart for modal window
    function buildModalEvolutionChart(evolutionData) {
        const ctx = document.getElementById("modalChart").getContext("2d")

        if (modalChart) {
            modalChart.destroy()
        }

        // Prepare chart data
        const dates = evolutionData.map(d => {
            const date = new Date(d.date)
            return `${date.getDate().toString().padStart(2, "0")}-${(date.getMonth() + 1).toString().padStart(2, "0")}-${date.getFullYear()}`
        })
        const topicGroups = {}

        evolutionData.forEach(analysis => {
            analysis.topics.forEach(topic => {
                if (!topicGroups[topic.topic]) {
                    topicGroups[topic.topic] = {
                        label: topic.topic,
                        data: new Array(dates.length).fill(0),
                        borderColor: getRandomColor(),
                        backgroundColor: "transparent",
                        tension: 0.1,
                    }
                }
            })
        })

        // Fill data
        evolutionData.forEach((analysis, index) => {
            analysis.topics.forEach(topic => {
                if (topicGroups[topic.topic]) {
                    topicGroups[topic.topic].data[index] = topic.prevalence
                }
            })
        })

        modalChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: dates,
                datasets: Object.values(topicGroups),
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Topic Importance",
                        },
                    },
                },
                plugins: {
                    legend: {
                        position: "top",
                    },
                    title: {
                        display: true,
                        text: "Topic Evolution Over Time",
                    },
                },
            },
        })
    }

    // Build evolution chart for main screen
    function buildEvolutionChart(evolutionData) {
        const ctx = document.getElementById("topicEvolutionChart").getContext("2d")

        if (topicEvolutionChart) {
            topicEvolutionChart.destroy()
        }

        // Prepare chart data
        const dates = evolutionData.map(d => {
            const date = new Date(d.date)
            return `${date.getDate().toString().padStart(2, "0")}-${(date.getMonth() + 1).toString().padStart(2, "0")}-${date.getFullYear()}`
        })

        const topicGroups = {}
        evolutionData.forEach(analysis => {
            analysis.topics.forEach(topic => {
                if (!topicGroups[topic.topic]) {
                    topicGroups[topic.topic] = {
                        label: topic.topic,
                        data: new Array(dates.length).fill(0),
                        borderColor: getRandomColor(),
                        backgroundColor: "transparent",
                        tension: 0.1,
                    }
                }
            })
        })

        // Fill data
        evolutionData.forEach((analysis, index) => {
            analysis.topics.forEach(topic => {
                if (topicGroups[topic.topic]) {
                    topicGroups[topic.topic].data[index] = topic.prevalence
                }
            })
        })

        topicEvolutionChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: dates,
                datasets: Object.values(topicGroups),
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Topic Importance",
                        },
                    },
                },
                plugins: {
                    legend: {
                        position: "top",
                    },
                    title: {
                        display: true,
                        text: "Topic Evolution Over Time",
                    },
                },
            },
        })
    }

    // Utility functions
    function formatDate(dateString) {
        if (!dateString) return "-"
        const date = new Date(dateString)
        return `${date.getDate().toString().padStart(2, "0")}-${(date.getMonth() + 1).toString().padStart(2, "0")}-${date.getFullYear()}`
    }

    function getRandomColor() {
        const letters = "0123456789ABCDEF"
        let color = "#"
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)]
        }
        return color
    }

    function refreshData() {
        loadTopicChains()
        loadOverviewStats()
    }

    function exportData() {
        alert("Export function will be implemented later")
    }
</script>
</body>
</html>
